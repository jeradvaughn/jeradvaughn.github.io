<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bradley's Light Controller</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        /* --- CHRISTMAS THEME STYLES --- */
        body { 
            font-family: sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #AD242C; /* Dark Christmas Green */
            color: #ECDEB9; /* White Text */
        }
        h1 { 
            text-align: center; 
            color: #ECDEB9; /* Gold/Yellow for Heading */
        }
        h2 {
            color: #ECDEB9; /* Firebrick Red for Section Headers */
            margin-top: 0;
        }
        
        /* Layout for the split top row */
        .top-row {
            display: flex;
            gap: 20px; /* Space between the two boxes */
            margin-bottom: 20px;
        }

        .control-section { 
            border: 2px solid #ECDEB9; /* Red border */
            padding: 15px; 
            border-radius: 8px; 
            background-color: #226F61; /* Slightly transparent overlay */
        }

        /* Specific style for full width sections below the split */
        .full-width {
            margin-bottom: 20px;
        }

        /* Make the split sections flexible to fill width */
        .top-row .control-section {
            flex: 1;
        }

        /* --- NEW GRID FOR EFFECTS --- */
        .effects-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 columns wide */
            gap: 10px; /* Space between buttons */
        }

        label, button, input[type="range"], input[type="color"] { 
            display: block; 
            margin-bottom: 10px; 
            color: #ECDEB9; /* Ensure labels are white */
        }
        button { 
            padding: 10px 15px; 
            cursor: pointer; 
            background-color: #B22222; /* Red Button */
            color: white; 
            border: none; 
            border-radius: 5px; 
            width: 100%; /* Buttons fill their container */
            font-size: 14px; /* Ensure text fits */
        }
        button:hover { opacity: 0.8; }
        #connectionStatus { font-weight: bold; margin-top: 10px; }
        #brightnessSlider { width: 100%; }
        
        /* Style for inputs that aren't buttons */
        input[type="range"], input[type="color"] {
            background-color: #086100;
            border: 1px solid #B22222;
            padding: 5px;
            border-radius: 5px;
        }

        /* Specific Button Styles */
        .button-group button { 
            margin-bottom: 10px;
            display: block; 
            width: 100%;
            background-color: #B22222; /* Default Red */
        }
        
        .button-group button.toggle { 
            background-color: #FFD700; /* Gold/Yellow Toggle */
            color: black; 
            font-weight: bold;
        }
        .button-group button.disconnect { 
            background-color: #A9A9A9; /* Dark Gray for Disconnect */
        }

        /* Responsive: Stack top row and reduce grid columns on small phones */
        @media (max-width: 480px) {
            .top-row { flex-direction: column; }
            .effects-grid { grid-template-columns: repeat(2, 1fr); } /* 2 wide on mobile */
        }
    </style>
</head>
<body>
    <h1>ðŸŽ„Bradley's Light ControllerðŸŽ„</h1>

    <div class="top-row">
        <div class="control-section">
            <h2>Connection</h2>
            <div class="button-group">
                <button onclick="connectClient()">Connect</button>
                <button class="disconnect" onclick="disconnectClient()">Disconnect</button>
            </div>
            <p>Status: <br><span id="connectionStatus">Disconnected</span></p>
        </div>

        <div class="control-section">
            <h2>Power</h2>
            <div class="button-group">
                <button onclick="publishBrightness('ON')">Turn ON</button>
                <button onclick="publishBrightness('OFF')">Turn OFF</button>
                <button class="toggle" onclick="publishBrightness('T')">TOGGLE</button>
            </div>
        </div>
    </div>

    <div class="control-section full-width">
        <h2>Lights Control (Sliders)</h2>
        
        <label for="brightnessSlider">Brightness (0-255): <span id="brightnessValue">128</span></label>
        <input type="range" id="brightnessSlider" min="0" max="255" value="128" onchange="updateBrightness(this.value)" onmouseup="publishBrightness(this.value)">

        <label for="colorPicker">Select Color:</label>
        <input type="color" id="colorPicker" value="#FFFFFF" onchange="publishColor(this.value)" style="width: 100%; height: 50px;">
    </div>

    <div class="control-section full-width">
        <h2>Effects</h2>
        <div class="effects-grid">
            <button onclick="publishMessage(DEVICE_TOPIC_API, 'FX=0')">Solid</button>
            <button onclick="publishMessage(DEVICE_TOPIC_API, 'FX=25')">Strobe Mega</button>
            <button onclick="publishMessage(DEVICE_TOPIC_API, 'FX=163')">Blurz</button>
            <button onclick="publishMessage(DEVICE_TOPIC_API, 'FX=91')">Bouncing Balls</button>
            
            <button onclick="publishMessage(DEVICE_TOPIC_API, 'FX=2')">Breathe</button>
            <button onclick="publishMessage(DEVICE_TOPIC_API, 'FX=28')">Chase</button>
            <button onclick="publishMessage(DEVICE_TOPIC_API, 'FX=30')">Chase Rainbow</button>
            <button onclick="publishMessage(DEVICE_TOPIC_API, 'FX=34')">Colorful</button>
            
            <button onclick="publishMessage(DEVICE_TOPIC_API, 'FX=112')">Dancing Shadows</button>
            <button onclick="publishMessage(DEVICE_TOPIC_API, 'FX=90')">Fireworks</button>
            <button onclick="publishMessage(DEVICE_TOPIC_API, 'FX=110')">Flow</button>
            <button onclick="publishMessage(DEVICE_TOPIC_API, 'FX=95')">Popcorn</button>
        </div>
    </div>

    <script>
        // --- MQTT Configuration ---
        const HOST = 'broker.hivemq.com'; 
        const PORT = 8884; // Secure WebSocket port, required for reliable browser connection
        const CLIENT_ID = 'web_client_' + Math.random().toString(16).substr(2, 8); 
        
        // WLED Topics 
        const DEVICE_TOPIC_BRIGHTNESS = 'wled/95ec80'; // [mqttDeviceTopic]
        const DEVICE_TOPIC_COLOR = 'wled/95ec80/col'; // [mqttDeviceTopic]/col
        const DEVICE_TOPIC_API = 'wled/95ec80/api';   // [mqttDeviceTopic]/api

        let client;

        /**
         * Helper function to update the connection status display.
         * @param {string} text - The status message to display.
         * @param {string} color - The color for the text.
         */
        function updateStatus(text, color) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = text;
            statusElement.style.color = color;
        }

        /**
         * Initializes and connects the MQTT client.
         */
        function connectClient() {
            if (client && client.isConnected()) {
                console.log("Client already connected.");
                updateStatus('Connected (Vaughn Snowflake)', 'lightgreen');
                return;
            }

            updateStatus('Connecting...', '#FFD700'); /* Gold status while connecting */
            client = new Paho.MQTT.Client(HOST, PORT, CLIENT_ID);
            client.onConnectionLost = onConnectionLost;

            client.connect({
                onSuccess: onConnect,
                onFailure: onFailure,
                cleanSession: true,
                useSSL: true // CRITICAL for browser security with public broker
            });
        }

        /**
         * Called when the connection is established.
         */
        function onConnect() {
            console.log("Connected successfully!");
            updateStatus('Connected (Vaughn Snowflake)', 'lightgreen');
        }

        /**
         * Called when the connection fails.
         * @param {Object} response - The failure response object.
         */
        function onFailure(response) {
            console.error("Connection failed: " + response.errorMessage);
            updateStatus('Failed to Connect: ' + response.errorMessage, '#FF4500'); /* OrangeRed for failure */
        }

        /**
         * Called when the connection is lost.
         * @param {Object} response - The connection lost response object.
         */
        function onConnectionLost(response) {
            if (response.reconnect) {
                console.log("Connection lost. Reconnecting...");
                updateStatus('Reconnecting...', '#FFD700');
            } else {
                console.log("Connection lost. Reason: " + response.errorMessage);
                updateStatus('Connection Lost', '#FF4500');
            }
        }

        /**
         * Disconnects the MQTT client.
         */
        function disconnectClient() {
            if (client && client.isConnected()) {
                client.disconnect();
                updateStatus('Disconnected', '#EA0D0D'); /* White text for disconnected */
                console.log("Disconnected from broker.");
            } else {
                updateStatus('Disconnected', '#EA0D0D'); 
                console.log("Client is not connected.");
            }
        }
        
        /**
         * Publishes a message to a specific topic.
         * @param {string} topic - The MQTT topic.
         * @param {string} payload - The message payload.
         */
        function publishMessage(topic, payload) {
            if (!client || !client.isConnected()) {
                alert('Not connected to MQTT broker! Please connect first.');
                console.warn('Attempted to publish without connection.');
                return;
            }
            
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            client.send(message);
            console.log(`Published to ${topic}: ${payload}`);
        }

        /**
         * Publishes the brightness (0-255, "ON", "OFF", or "T")
         * @param {string|number} value - The brightness value or command.
         */
        function publishBrightness(value) {
            publishMessage(DEVICE_TOPIC_BRIGHTNESS, String(value));
        }

        /**
         * Updates the slider text value (does not publish).
         * @param {string} value - The slider value.
         */
        function updateBrightness(value) {
            document.getElementById('brightnessValue').textContent = value;
        }

        /**
         * Publishes the selected color as a HEX string.
         * @param {string} hexColor - The color in #RRGGBB format (e.g., "#FF00AA").
         */
        function publishColor(hexColor) {
            publishMessage(DEVICE_TOPIC_COLOR, hexColor);
        }

        // Set initial status
        window.onload = () => updateStatus('Disconnected', '#FFFFFF');
    </script>
</body>
</html>
