<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WLED MQTT Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #007bff; }
        .control-section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        label, button, input[type="range"], input[type="color"] { display: block; margin-bottom: 10px; }
        button { padding: 10px 15px; cursor: pointer; background-color: #28a745; color: white; border: none; border-radius: 5px; }
        button:hover { opacity: 0.9; }
        #connectionStatus { font-weight: bold; margin-top: 10px; }
        #brightnessSlider { width: 100%; }
        .button-group button { margin-right: 10px; display: inline-block; width: auto; background-color: #007bff; }
        .button-group button:last-child { margin-right: 0; }
        .button-group button.toggle { background-color: #ffc107; color: black; }
        .button-group button.disconnect { background-color: #dc3545; }
    </style>
</head>
<body>
    <h1>ðŸ’¡ Bradley's Christmas Light Controller</h1>

    <div class="control-section">
        <h2>Connection</h2>
        <div class="button-group">
            <button onclick="connectClient()">Connect to Jerad's Snowflake</button>
            <button class="disconnect" onclick="disconnectClient()">Disconnect</button>
        </div>
        <p>Status: <span id="connectionStatus">Disconnected</span></p>
    </div>

    <div class="control-section">
        <h2>Lights Control</h2>
        
        <div class="button-group">
            <button onclick="publishBrightness('ON')">Turn ON</button>
            <button onclick="publishBrightness('OFF')">Turn OFF</button>
            <button class="toggle" onclick="publishBrightness('T')">TOGGLE</button>
        </div>

        <label for="brightnessSlider">Brightness (0-255): <span id="brightnessValue">128</span></label>
        <input type="range" id="brightnessSlider" min="0" max="255" value="128" onchange="updateBrightness(this.value)" onmouseup="publishBrightness(this.value)">

        <label for="colorPicker">Select Color:</label>
        <input type="color" id="colorPicker" value="#FFFFFF" onchange="publishColor(this.value)">
    </div>

    <script>
        // --- MQTT Configuration ---
        const HOST = 'broker.hivemq.com'; // HiveMQ public broker
        const PORT = 8884; // WebSocket port
        const CLIENT_ID = 'web_client_' + Math.random().toString(16).substr(2, 8); // Unique client ID
        
        // WLED Topics (from your information)
        const DEVICE_TOPIC_BRIGHTNESS = 'wled/95ec80'; // [mqttDeviceTopic]
        const DEVICE_TOPIC_COLOR = 'wled/95ec80/col'; // [mqttDeviceTopic]/col

        let client;

        /**
         * Initializes and connects the MQTT client.
         */
        function connectClient() {
            if (client && client.isConnected()) {
                console.log("Client already connected.");
                return;
            }

            // Create a client instance
            client = new Paho.MQTT.Client(HOST, PORT, CLIENT_ID);

            // Set callback handlers
            client.onConnectionLost = onConnectionLost;
            // No need for onMessageArrived for this basic controller

            // Connect the client
            console.log('Connecting to ' + HOST + ':' + PORT);
            client.connect({
                onSuccess: onConnect,
                onFailure: onFailure,
                cleanSession: true,
                useSSL: true
            });
        }

        /**
         * Called when the connection is established.
         */
        function onConnect() {
            console.log("Connected successfully!");
            document.getElementById('connectionStatus').textContent = 'Connected (Broker: HiveMQ)';
            document.getElementById('connectionStatus').style.color = 'green';
            // You could subscribe to state topics here if you wanted
            // client.subscribe('wled/95ec80/g');
        }

        /**
         * Called when the connection fails.
         * @param {Object} response - The failure response object.
         */
        function onFailure(response) {
            console.error("Connection failed: " + response.errorMessage);
            document.getElementById('connectionStatus').textContent = 'Failed to Connect: ' + response.errorMessage;
            document.getElementById('connectionStatus').style.color = 'red';
        }

        /**
         * Called when the connection is lost.
         * @param {Object} response - The connection lost response object.
         */
        function onConnectionLost(response) {
            if (response.reconnect) {
                console.log("Connection lost. Reconnecting...");
            } else {
                console.log("Connection lost. Reason: " + response.errorMessage);
            }
            document.getElementById('connectionStatus').textContent = 'Connection Lost';
            document.getElementById('connectionStatus').style.color = 'orange';
        }

        /**
         * Disconnects the MQTT client.
         */
        function disconnectClient() {
            if (client && client.isConnected()) {
                client.disconnect();
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                document.getElementById('connectionStatus').style.color = 'black';
                console.log("Disconnected from broker.");
            } else {
                console.log("Client is not connected.");
            }
        }
        
        /**
         * Publishes a message to a specific topic.
         * @param {string} topic - The MQTT topic.
         * @param {string} payload - The message payload.
         */
        function publishMessage(topic, payload) {
            if (!client || !client.isConnected()) {
                alert('Not connected to MQTT broker! Please connect first.');
                console.warn('Attempted to publish without connection.');
                return;
            }
            
            // Create a new Paho message
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            
            // Publish the message
            client.send(message);
            console.log(`Published to ${topic}: ${payload}`);
        }

        /**
         * Publishes the brightness (0-255, "ON", "OFF", or "T")
         * @param {string|number} value - The brightness value or command.
         */
        function publishBrightness(value) {
            // The value is sent as a string payload
            publishMessage(DEVICE_TOPIC_BRIGHTNESS, String(value));
        }

        /**
         * Updates the slider text value (does not publish).
         * @param {string} value - The slider value.
         */
        function updateBrightness(value) {
            document.getElementById('brightnessValue').textContent = value;
        }

        /**
         * Publishes the selected color as a HEX string.
         * @param {string} hexColor - The color in #RRGGBB format (e.g., "#FF00AA").
         */
        function publishColor(hexColor) {
            // WLED expects color as HEX with prefix '#', so we send the standard output.
            publishMessage(DEVICE_TOPIC_COLOR, hexColor);
        }

        // Connect automatically when the page loads (optional, but helpful for testing)
        // window.onload = connectClient;

    </script>
</body>
</html>
